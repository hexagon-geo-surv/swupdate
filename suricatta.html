<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suricatta daemon mode &mdash; Embedded Software Update Documentation 2025.05 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=86f27845" />

  
    <link rel="shortcut icon" href="_static/SWUpdate.ico"/>
  
        <script src="_static/jquery.js?v=8dae8fb0"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=ffeffead"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Config for hawkBit under SSL/TLS using private CA / sub CA" href="hawkbit-setup.html" />
    <link rel="prev" title="Mongoose daemon mode" href="mongoose.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Embedded Software Update Documentation
          </a>
              <div class="version">
                2025.05
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Software Management on embedded systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="licensing.html">License</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="swupdate.html">SWUpdate: software update for embedded system</a></li>
<li class="toctree-l1"><a class="reference internal" href="scenarios.html">Update strategy examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="sw-description.html">SWUpdate: syntax and tags with the default parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="signed_images.html">Update images from verified source</a></li>
<li class="toctree-l1"><a class="reference internal" href="encrypted_images.html">Symmetrically Encrypted Update Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="handlers.html">Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongoose.html">Mongoose daemon mode</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Suricatta daemon mode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-suricatta">Running suricatta</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-suricatta-interface">The Suricatta Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#support-for-wfx">Support for wfx</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#job-definition">Job Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#workflows">Workflows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-activation">Update Activation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#support-for-general-purpose-http-server">Support for general purpose HTTP server</a></li>
<li class="toctree-l2"><a class="reference internal" href="#support-for-suricatta-modules-in-lua">Support for Suricatta Modules in Lua</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#suricatta"><cite>suricatta</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-status"><cite>suricatta.status</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-notify"><cite>suricatta.notify</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-pstate"><cite>suricatta.pstate</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-server"><cite>suricatta.server</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-channel"><cite>suricatta.channel</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#suricatta-bootloader"><cite>suricatta.bootloader</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="#lua-suricatta-interface-specification">Lua Suricatta Interface Specification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hawkbit-setup.html">Config for hawkBit under SSL/TLS using private CA / sub CA</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-ipc-interface.html">SWUpdate: API for external programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress.html">Getting information on running update</a></li>
<li class="toctree-l1"><a class="reference internal" href="bindings.html">Language Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootloader_interface.html">Bootloader Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="building-with-yocto.html">meta-swupdate: building with Yocto</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-best-practise.html">SWUpdate Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="delta-update.html">Delta Update with SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="swupdate-client.html">swupdate-client</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-progress.html">swupdate-progress</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-ipc.html">swupdate-ipc</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="help_and_support.html">Help and support</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improvement_proposals.html">Proposals to improve SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="previous-releases.html">Documentation for previous releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Embedded Software Update Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Suricatta daemon mode</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/suricatta.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="suricatta-daemon-mode">
<h1>Suricatta daemon mode<a class="headerlink" href="#suricatta-daemon-mode" title="Link to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Suricatta is – like mongoose – a daemon mode of SWUpdate, hence the
name suricatta (engl. meerkat) as it belongs to the mongoose family.</p>
<p>Suricatta regularly polls a remote server for updates, downloads, and
installs them. Thereafter, it reboots the system and reports the update
status to the server, based on an update state variable currently stored
in bootloader’s environment ensuring persistent storage across reboots. Some
U-Boot script logics or U-Boot’s <code class="docutils literal notranslate"><span class="pre">bootcount</span></code> feature may be utilized
to alter this update state variable, e.g., by setting it to reflect
failure in case booting the newly flashed root file system has failed
and a switchback had to be performed.</p>
<p>Suricatta is designed to be extensible in terms of the servers supported
as described in Section <a class="reference internal" href="#the-suricatta-interface">The Suricatta Interface</a>. Currently,
support for the <a class="reference external" href="https://projects.eclipse.org/projects/iot.hawkbit">hawkBit</a> server is implemented via the <a class="reference external" href="http://sp.apps.bosch-iot-cloud.com/documentation/developerguide/apispecifications/directdeviceintegrationapi.html">hawkBit Direct
Device Integration API</a> alongside a simple general purpose HTTP server.
The support for suricatta modules written in Lua is not a particular server
support implementation but rather an option for writing such in Lua instead
of C.</p>
</section>
<section id="running-suricatta">
<h2>Running suricatta<a class="headerlink" href="#running-suricatta" title="Link to this heading"></a></h2>
<p>After having configured and compiled SWUpdate with enabled suricatta
support for hawkBit,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">swupdate</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<p>lists the mandatory and optional arguments to be provided to suricatta
when using hawkBit as server. As an example,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./swupdate<span class="w"> </span>-l<span class="w"> </span><span class="m">5</span><span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;-t default -u http://10.0.0.2:8080 -i 25&#39;</span>
</pre></div>
</div>
<p>runs SWUpdate in suricatta daemon mode with log-level <code class="docutils literal notranslate"><span class="pre">TRACE</span></code>, polling
a hawkBit instance at <code class="docutils literal notranslate"><span class="pre">http://10.0.0.2:8080</span></code> with tenant <code class="docutils literal notranslate"><span class="pre">default</span></code>
and device ID <code class="docutils literal notranslate"><span class="pre">25</span></code>.</p>
<p>If multiple server support is compiled in, the <code class="docutils literal notranslate"><span class="pre">-S</span></code> / <code class="docutils literal notranslate"><span class="pre">--server</span></code>
option or a <code class="docutils literal notranslate"><span class="pre">server</span></code> entry in the configuration file’s <code class="docutils literal notranslate"><span class="pre">[suricatta]</span></code>
section selects the one to use at run-time. For convenience, when having
support for just one server compiled-in, this is chosen automatically.</p>
<p>Note that on startup when having installed an update, suricatta
tries to report the update status to its upstream server, e.g.,
hawkBit, prior to entering the main loop awaiting further updates.
If this initial report fails, e.g., because of a not (yet) configured
network or a currently unavailable hawkBit server, SWUpdate may exit
with an according error code. This behavior allows one to, for example,
try several upstream servers sequentially.
If suricatta should keep retrying until the update status is reported
to its upstream server irrespective of the error conditions, this has
to be realized externally in terms of restarting SWUpdate on exit.</p>
<p>After an update has been performed, an agent listening on the progress
interface may execute post-update actions, e.g., a reboot, on receiving
<code class="docutils literal notranslate"><span class="pre">DONE</span></code>.
Additionally, a post-update command specified in the configuration file or
given by the <code class="docutils literal notranslate"><span class="pre">-p</span></code> command line option can be executed.</p>
<p>Note that at least a restart of SWUpdate has to be performed as post-update
action since only then suricatta tries to report the update status to its
upstream server. Otherwise, succinct update actions announced by the
upstream server are skipped with an according message until a restart of
SWUpdate has happened in order to not install the same update again.</p>
</section>
<section id="the-suricatta-interface">
<h2>The Suricatta Interface<a class="headerlink" href="#the-suricatta-interface" title="Link to this heading"></a></h2>
<p>Support for servers other than hawkBit or the general purpose HTTP server can be
realized by implementing the “interfaces” described in <code class="docutils literal notranslate"><span class="pre">include/channel.h</span></code> and
<code class="docutils literal notranslate"><span class="pre">include/suricatta/server.h</span></code>, the latter either in C or in Lua.
The channel interface abstracts a particular connection to the server, e.g.,
HTTP-based in case of hawkBit. The server interface defines the logics to poll
and install updates. See <code class="docutils literal notranslate"><span class="pre">corelib/channel_curl.c</span></code> / <code class="docutils literal notranslate"><span class="pre">include/channel_curl.h</span></code>
and <code class="docutils literal notranslate"><span class="pre">suricatta/server_hawkbit.{c,h}</span></code> for an example implementation in C targeted
towards hawkBit.</p>
<p><code class="docutils literal notranslate"><span class="pre">include/channel.h</span></code> describes the functionality a channel
has to implement:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">channel</span><span class="w"> </span><span class="n">channel_t</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">channel</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">};</span>

<span class="n">channel_t</span><span class="w"> </span><span class="o">*</span><span class="nf">channel_new</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<p>which sets up and returns a <code class="docutils literal notranslate"><span class="pre">channel_t</span></code> struct with pointers to
functions for opening, closing, fetching, and sending data over
the channel.</p>
<p><code class="docutils literal notranslate"><span class="pre">include/suricatta/server.h</span></code> describes the functionality a server has
to implement:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">has_pending_action</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">action_id</span><span class="p">);</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">install_update</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">send_target_data</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">get_polling_interval</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cfgfname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="w">    </span><span class="n">server_op_res_t</span><span class="w"> </span><span class="nf">ipc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">help</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="n">server_t</span><span class="p">;</span>
</pre></div>
</div>
<p>These functions constituting a particular suricatta server implementation
have to be registered for being selectable at run-time by calling
<code class="docutils literal notranslate"><span class="pre">register_server()</span></code> (see <code class="docutils literal notranslate"><span class="pre">include/suricatta/server.h</span></code>) with
a name and a <code class="docutils literal notranslate"><span class="pre">server_t</span></code> struct pointer implemented in a
<code class="docutils literal notranslate"><span class="pre">__attribute__((constructor))</span></code> marked function, see
<code class="docutils literal notranslate"><span class="pre">suricatta/server_hawkbit.c</span></code> as example.</p>
<p>The type <code class="docutils literal notranslate"><span class="pre">server_op_res_t</span></code> is defined in <code class="docutils literal notranslate"><span class="pre">include/suricatta/suricatta.h</span></code>.
It represents the valid function return codes for a server’s implementation.</p>
<p>In addition to implementing the particular channel and server, the
<code class="docutils literal notranslate"><span class="pre">suricatta/Kconfig</span></code> file has to be adapted to include a new option
so that the new implementation becomes selectable in SWUpdate’s
configuration. In the simplest case, adding an option like the following
one for hawkBit into the <code class="docutils literal notranslate"><span class="pre">menu</span> <span class="pre">&quot;Server&quot;</span></code> section is sufficient.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>config<span class="w"> </span>SURICATTA_HAWKBIT
<span class="w">    </span>bool<span class="w"> </span><span class="s2">&quot;hawkBit support&quot;</span>
<span class="w">    </span>default<span class="w"> </span>y
<span class="w">    </span><span class="k">select</span><span class="w"> </span>JSON
<span class="w">    </span><span class="nb">help</span>
<span class="w">      </span>Support<span class="w"> </span><span class="k">for</span><span class="w"> </span>hawkBit<span class="w"> </span>server.
<span class="w">      </span>https://projects.eclipse.org/projects/iot.hawkbit
</pre></div>
</div>
<p>Having included the new server implementation into the configuration,
edit <code class="docutils literal notranslate"><span class="pre">suricatta/Makefile</span></code> to specify the implementation’s linkage into
the SWUpdate binary, e.g., for the hawkBit example implementation, the
following lines add <code class="docutils literal notranslate"><span class="pre">server_hawkbit.o</span></code> to the resulting SWUpdate binary
if <code class="docutils literal notranslate"><span class="pre">SURICATTA_HAWKBIT</span></code> was selected while configuring SWUpdate.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ifneq<span class="w"> </span><span class="o">(</span><span class="k">$(</span>CONFIG_SURICATTA_HAWKBIT<span class="k">)</span>,<span class="o">)</span>
obj-<span class="k">$(</span>CONFIG_SURICATTA<span class="k">)</span><span class="w"> </span>+<span class="o">=</span><span class="w"> </span>server_hawkbit.o
endif
</pre></div>
</div>
</section>
<section id="support-for-wfx">
<h2>Support for wfx<a class="headerlink" href="#support-for-wfx" title="Link to this heading"></a></h2>
<p>The <a class="reference external" href="https://github.com/siemens/wfx">wfx</a> server is supported by the Lua Suricatta module
<code class="docutils literal notranslate"><span class="pre">suricatta/server_wfx.lua</span></code> (cf. Section <a class="reference internal" href="#support-for-suricatta-modules-in-lua">Support for Suricatta Modules in Lua</a>).
Specifically, it implements a binding to the <a class="reference external" href="https://github.com/siemens/wfx/tree/main/workflow/dau">Device Artifact Update</a> (DAU) workflow
family.</p>
<p>If enabled via <code class="docutils literal notranslate"><span class="pre">CONFIG_SURICATTA_WFX</span></code>, the wfx Lua Suricatta module is embedded
into the SWUpdate binary so that no extra deployment steps are required. Note that
this is purely a convenience shortcut for the installation of a Lua Suricatta module
as described in <a class="reference internal" href="#support-for-suricatta-modules-in-lua">Support for Suricatta Modules in Lua</a>.</p>
<section id="job-definition">
<h3>Job Definition<a class="headerlink" href="#job-definition" title="Link to this heading"></a></h3>
<p>As being a general purpose workflow executor, wfx doesn’t impose a particular job
definition nor schema, except that it’s in JSON format. Instead, the job definition
is a contract between the operator creating jobs, each possibly following a different
workflow, and the client(s) executing those jobs in lock-step with the wfx.</p>
<p>The wfx Lua Suricatta module understands job definitions as in the following
example (see <code class="docutils literal notranslate"><span class="pre">job.definition.json_schema</span></code> in <code class="docutils literal notranslate"><span class="pre">suricatta/server_wfx.lua</span></code>):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;firmware&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dummy&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;artifacts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Example Device Firmware Artifact&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:8080/download/example_artifact.swu&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> list field allows to label update jobs. Labels are sent <code class="docutils literal notranslate"><span class="pre">:</span></code>-concatenated
to the progress interface on <a class="reference internal" href="#update-activation">Update Activation</a>. The only predefined label <code class="docutils literal notranslate"><span class="pre">firmware</span></code>
instructs the wfx Lua Suricatta module to record an installed update to the bootloader
environment (see <a class="reference internal" href="bootloader_interface.html"><span class="doc">Bootloader Interface</span></a>).
Within the artifacts list, only the <code class="docutils literal notranslate"><span class="pre">uri</span></code> field is strictly required for each artifact
while the fields <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code> are used for informational purposes, if provided.
Further fields, including top-level fields, are ignored on purpose and may be freely used,
e.g., to enrich the job definition with metadata for update management.</p>
<p>Since wfx is not concerned with the job definition except for conveying it to the
client (i.e. SWUpdate), it can be adapted to specific needs by feeding a different
job definition into the wfx on job creation and adapting the verification and job
handling methods in the wfx Lua Suricatta module’s <code class="docutils literal notranslate"><span class="pre">job.definition</span> <span class="pre">=</span> <span class="pre">{...}</span></code> Table.</p>
</section>
<section id="workflows">
<h3>Workflows<a class="headerlink" href="#workflows" title="Link to this heading"></a></h3>
<p>The two Device Artifact Update (DAU) workflows <a class="reference external" href="https://github.com/siemens/wfx/blob/main/workflow/dau/wfx.workflow.dau.direct.yml">wfx.workflow.dau.direct</a> and
<a class="reference external" href="https://github.com/siemens/wfx/blob/main/workflow/dau/wfx.workflow.dau.phased.yml">wfx.workflow.dau.phased</a> are supported by the wfx Lua Suricatta module.
Hint: Use wfx’s <code class="docutils literal notranslate"><span class="pre">wfx-viewer</span></code> command line tool to visualize the  YAML
workflows in SVG or PlantUML format.</p>
<p>For each transition in a workflow for which the <code class="docutils literal notranslate"><span class="pre">eligible</span></code> field contains
<code class="docutils literal notranslate"><span class="pre">CLIENT</span></code>, e.g.,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">transitions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;FROM_STATE&gt;</span>
<span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;TO_STATE&gt;</span>
<span class="w">    </span><span class="nt">eligible</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CLIENT</span>
</pre></div>
</div>
<p>there has to be a matching transition execution function defined in the wfx Lua
Suricatta module. It executes the client actions to go from state <code class="docutils literal notranslate"><span class="pre">&lt;FROM_STATE&gt;</span></code>
to state <code class="docutils literal notranslate"><span class="pre">&lt;TO_STATE&gt;</span></code> and finally sends the new job status to the wfx, updating it:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="p">.</span><span class="n">workflow</span><span class="p">.</span><span class="n">dispatch</span><span class="p">:</span><span class="n">set</span><span class="p">(</span>
    <span class="s2">&quot;&lt;FROM_STATE&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;TO_STATE&gt;&quot;</span><span class="p">,</span>
    <span class="c1">--- @param  self  job.workflow.transition</span>
    <span class="c1">--- @param  job   job</span>
    <span class="c1">--- @return transition.result</span>
    <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="kr">if</span> <span class="ow">not</span> <span class="n">job</span><span class="p">.</span><span class="n">status</span>
            <span class="p">:</span><span class="n">set</span><span class="p">({</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="c1">-- resolves to `&lt;TO_STATE&gt;`</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[%s] &lt;TO_STATE&gt; reached&quot;</span><span class="p">):</span><span class="n">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="p">:</span><span class="n">send</span><span class="p">()</span> <span class="kr">then</span>
            <span class="c1">-- Do not try to execute further transitions, yield to wfx.</span>
            <span class="kr">return</span> <span class="n">transition</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">FAIL_YIELD</span>
        <span class="kr">end</span>
        <span class="kr">return</span> <span class="n">transition</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">COMPLETED</span>
    <span class="kr">end</span>
<span class="p">)</span>
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">suricatta/server_wfx.lua</span></code> for examples of such transition execution functions.</p>
<p>New or adapted workflows are supported by appropriately defining/modifying the
transition execution functions in <code class="docutils literal notranslate"><span class="pre">suricatta/server_wfx.lua</span></code> – or taking it as
inspiration and creating a new wfx Lua Suricatta module as described in <a class="reference internal" href="#support-for-suricatta-modules-in-lua">Support
for Suricatta Modules in Lua</a>.</p>
</section>
<section id="update-activation">
<h3>Update Activation<a class="headerlink" href="#update-activation" title="Link to this heading"></a></h3>
<p>The Device Artifact Update (DAU) workflows offer a dedicated activation step in
the update steps sequence to decouple artifact installation and activation times
so to not, e.g., upon a power-cut, prematurely test-boot into the new firmware
after installation until the activation is actually due.</p>
<p>When the activation step is executed, the wfx Lua Suricatta module sends a progress
message (see <a class="reference internal" href="progress.html"><span class="doc">Getting information on running update</span></a>) upon which a progress client executes or schedules
activation measures. For example, the following JSON is sent as the progress
message’s <code class="docutils literal notranslate"><span class="pre">.info</span></code> field on activation of the <a class="reference internal" href="#job-definition">Job Definition</a> example given above:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ACTIVATING&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;progress&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;firmware:dummy&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The progress message’s <code class="docutils literal notranslate"><span class="pre">.status</span></code> is <code class="docutils literal notranslate"><span class="pre">PROGRESS</span></code>, see <code class="docutils literal notranslate"><span class="pre">tools/swupdate-progress.c</span></code>
for details on how a progress client can be implemented.</p>
<p><strong>Note:</strong> The activation message may be sent multiple times if the update activation
is pending, namely on each wfx poll operation and if a new update job is enqueued
while the current one is not activated.</p>
<p>Because of the (predefined) <code class="docutils literal notranslate"><span class="pre">firmware</span></code> label present, the progress client should
initiate or schedule a reboot of the device in order to test-boot the new firmware.
Also because of the <code class="docutils literal notranslate"><span class="pre">firmware</span></code> label present, the wfx Lua Suricatta module records
the installed update to the bootloader environment. If this label was missing, no such
recording would’ve been made which is suitable for, e.g., configuration or
application updates.</p>
<p>In order for the this mechanism to work, SWUpdate must not record the update to the
bootloader environment after it has installed it or, in case of configuration or
application updates, must not touch the bootloader environment at all (see the
Sections <cite>Update Transaction and Status Marker</cite> and <cite>bootloader</cite> in
<a class="reference internal" href="sw-description.html"><span class="doc">SWUpdate: syntax and tags with the default parser</span></a>).</p>
<p>Hence, for firmware updates requiring a test-boot into the new firmware, the
following properties should be set in the <code class="docutils literal notranslate"><span class="pre">.swu</span></code> file’s <code class="docutils literal notranslate"><span class="pre">sw-description</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">software</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="n">bootloader_transaction_marker</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">bootloader_state_marker</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>For configuration or application updates, the following properties apply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">software</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="n">bootloader_transaction_marker</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="n">bootloader_state_marker</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="support-for-general-purpose-http-server">
<h2>Support for general purpose HTTP server<a class="headerlink" href="#support-for-general-purpose-http-server" title="Link to this heading"></a></h2>
<p>This is a very simple backend that uses standard HTTP response codes to signal if
an update is available. There are closed source backends implementing this interface,
but because the interface is very simple interface, this server type is also suitable
for implementing an own backend server. For inspiration, there’s a simple (mock)
server implementation available in <code class="docutils literal notranslate"><span class="pre">examples/suricatta/server_general.py</span></code>.</p>
<p>The API consists of a GET with Query parameters to inform the server about the installed version.
The query string has the format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http(s)://&lt;base URL&gt;?param1=val1&amp;param2=value2...
</pre></div>
</div>
<p>As examples for parameters, the device can send its serial number, MAC address and the running version of the software.
It is duty of the backend to interpret this - SWUpdate just takes them from the “identify” section of
the configuration file and encodes the URL.</p>
<p>The server answers with the following return codes:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>HTTP Code</p></th>
<th class="head"><p>Text</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>302</p></td>
<td><p>Found</p></td>
<td><p>A new software is available at URL in the Location header</p></td>
</tr>
<tr class="row-odd"><td><p>400</p></td>
<td><p>Bad Request</p></td>
<td><p>Some query parameters are missing or in wrong format</p></td>
</tr>
<tr class="row-even"><td><p>403</p></td>
<td><p>Forbidden</p></td>
<td><p>Client certificate not valid</p></td>
</tr>
<tr class="row-odd"><td><p>404</p></td>
<td><p>Not found</p></td>
<td><p>No update is available for this device</p></td>
</tr>
<tr class="row-even"><td><p>503</p></td>
<td><p>Unavailable</p></td>
<td><p>An update is available but server can’t handle another
update process now.</p></td>
</tr>
</tbody>
</table>
<p>Server’s answer can contain the following headers:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Header’s name</p></th>
<th class="head"><p>Codes</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Retry-after</p></td>
<td><p>503</p></td>
<td><p>Contains a number which tells the device how long to wait
until ask the next time for updates. (Seconds)</p></td>
</tr>
<tr class="row-odd"><td><p>Content-MD5</p></td>
<td><p>302</p></td>
<td><p>Contains the checksum of the update file which is available
under the url of location header</p></td>
</tr>
<tr class="row-even"><td><p>Location</p></td>
<td><p>302</p></td>
<td><p>URL where the update file can be downloaded.</p></td>
</tr>
</tbody>
</table>
<p>The device can send logging data to the server. Any information is transmitted in a HTTP
PUT request with the data as plain string in the message body. The Content-Type Header
need to be set to text/plain.</p>
<p>The URL for the logging can be set as separate URL in the configuration file or via
–logurl command line parameter:</p>
<p>The device sends data in a CSV format (Comma Separated Values). The format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">value1</span><span class="p">,</span><span class="n">value2</span><span class="p">,</span><span class="o">...</span>
</pre></div>
</div>
<p>The format can be specified in the configuration file. A <em>format</em> For each <em>event</em> can be set.
The supported events are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Event</p></th>
<th class="head" colspan="2"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>check</p></td>
<td colspan="2"><p>dummy. It could send an event each time the server is
polled.</p></td>
</tr>
<tr class="row-odd"><td><p>started</p></td>
<td colspan="2"><p>A new software is found and SWUpdate starts to install it</p></td>
</tr>
<tr class="row-even"><td><p>success</p></td>
<td colspan="2"><p>A new software was successfully installed</p></td>
</tr>
<tr class="row-odd"><td><p>fail</p></td>
<td colspan="2"><p>Failure by installing the new software</p></td>
</tr>
</tbody>
</table>
<p>The <cite>general server</cite> has an own section inside the configuration file. As example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gservice</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="n">url</span>             <span class="o">=</span> <span class="o">....</span><span class="p">;</span>
        <span class="n">logurl</span>          <span class="o">=</span> <span class="p">;</span>
        <span class="n">logevent</span> <span class="p">:</span> <span class="p">(</span>
                <span class="p">{</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;check&quot;</span><span class="p">;</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;#2,date,fw,hw,sp&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span><span class="p">;</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;#12,date,fw,hw,sp&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span><span class="p">;</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;#13,date,fw,hw,sp&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">;</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;#14,date,fw,hw,sp&quot;</span><span class="p">}</span>
        <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><cite>date</cite> is a special field and it is interpreted as localtime in RFC 2822 format. Each
Comma Separated field is looked up inside the <cite>identify</cite> section in the configuration
file, and if a match is found the substitution occurs. In case of no match, the field
is sent as it is. For example, if the identify section has the following values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">identify</span> <span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sp&quot;</span><span class="p">;</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;333&quot;</span><span class="p">;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hw&quot;</span><span class="p">;</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;ipse&quot;</span><span class="p">;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fw&quot;</span><span class="p">;</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>with the events set as above, the formatted text in case of “success” will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Formatted</span> <span class="n">log</span><span class="p">:</span> <span class="c1">#13,Mon, 17 Sep 2018 10:55:18 CEST,1.0,ipse,333</span>
</pre></div>
</div>
</section>
<section id="support-for-suricatta-modules-in-lua">
<h2>Support for Suricatta Modules in Lua<a class="headerlink" href="#support-for-suricatta-modules-in-lua" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">server_lua.c</span></code> C-to-Lua bridge enables writing suricatta modules in Lua. It
provides the infrastructure in terms of the interface to SWUpdate “core” to the Lua
realm, enabling the “business logic” such as handling update flows and communicating
with backend server APIs to be modeled in Lua. To the Lua realm, the <code class="docutils literal notranslate"><span class="pre">server_lua.c</span></code>
C-to-Lua bridge provides the same functionality as the other suricatta modules
written in C have, realizing a separation of means and control. Effectively, it lifts
the interface outlined in Section <a class="reference internal" href="#the-suricatta-interface">The Suricatta Interface</a> to the Lua realm.</p>
<p>As an example server implementation, see <code class="docutils literal notranslate"><span class="pre">examples/suricatta/server_general.py</span></code> for
a simple (mock) server of a backend that’s modeled after the “General Purpose HTTP
Server” (cf. Section <a class="reference internal" href="#support-for-general-purpose-http-server">Support for general purpose HTTP server</a>). The matching Lua
suricatta module is found in <code class="docutils literal notranslate"><span class="pre">examples/suricatta/swupdate_suricatta.lua</span></code>. Place it in
Lua’s path so that a <code class="docutils literal notranslate"><span class="pre">require(&quot;swupdate_suricatta&quot;)</span></code> can load it or embed it into the
SWUpdate binary by enabling <code class="docutils literal notranslate"><span class="pre">CONFIG_EMBEDDED_SURICATTA_LUA</span></code> and setting
<code class="docutils literal notranslate"><span class="pre">CONFIG_EMBEDDED_SURICATTA_LUA_SOURCE</span></code> accordingly.</p>
<p>The interface specification in terms of a Lua (suricatta) module is found in
<code class="docutils literal notranslate"><span class="pre">suricatta/suricatta.lua</span></code>, reproduced for convenience in
Section <a class="reference internal" href="#suricatta-lua-specification"><span class="std std-ref">Lua Suricatta Interface Specification</span></a>.</p>
<section id="suricatta">
<h3><cite>suricatta</cite><a class="headerlink" href="#suricatta" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta</span></code> table is the module’s main table housing the exposed functions and
definitions via the sub-tables described below.
In addition, the main functions <code class="docutils literal notranslate"><span class="pre">suricatta.install()</span></code> and <code class="docutils literal notranslate"><span class="pre">suricatta.download()</span></code>
as well as the convenience functions <code class="docutils literal notranslate"><span class="pre">suricatta.getversion()</span></code>, <code class="docutils literal notranslate"><span class="pre">suricatta.sleep()</span></code>,
and <code class="docutils literal notranslate"><span class="pre">suricatta.get_tmpdir()</span></code> are exposed:</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.install(install_channel)</span></code> installs an update artifact from
a remote server or a local file. The <code class="docutils literal notranslate"><span class="pre">install_channel</span></code> table parameter designates
the channel to be used for accessing the artifact plus channel options diverging
from the defaults set at channel creation time. For example, an <code class="docutils literal notranslate"><span class="pre">install_channel</span></code>
table may look like this:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">chn</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://artifacts.io/update.swu&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">chn</span></code> is the return value of a call to <code class="docutils literal notranslate"><span class="pre">channel.open()</span></code>. The other table
attributes, like <code class="docutils literal notranslate"><span class="pre">url</span></code> in this example, are channel options diverging from or
omitted while channel creation time, see <a class="reference internal" href="#suricatta-channel"><span class="std std-ref">suricatta.channel</span></a>. For installing
a local file, an <code class="docutils literal notranslate"><span class="pre">install_channel</span></code> table may look like this:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">chn</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;file:///path/to/file.swu&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.download(download_channel,</span> <span class="pre">localpath)</span></code> just downloads an
update artifact. The parameter <code class="docutils literal notranslate"><span class="pre">download_channel</span></code> is as for <code class="docutils literal notranslate"><span class="pre">suricatta.install()</span></code>.
The parameter <code class="docutils literal notranslate"><span class="pre">localpath</span></code> designates the output path for the artifact. The
<code class="docutils literal notranslate"><span class="pre">suricatta.get_tmpdir()</span></code> function (see below) is in particular useful for this case
to supply a temporary download location as <code class="docutils literal notranslate"><span class="pre">localpath</span></code>. A just downloaded artifact
may be installed later using <code class="docutils literal notranslate"><span class="pre">suricata.install()</span></code> with an appropriate <code class="docutils literal notranslate"><span class="pre">file://</span></code>
URL, realizing a deferred installation.</p>
<p>Both, <code class="docutils literal notranslate"><span class="pre">suricatta.install()</span></code> and <code class="docutils literal notranslate"><span class="pre">suricatta.download()</span></code> return <code class="docutils literal notranslate"><span class="pre">true</span></code>, or, in
case of error, <code class="docutils literal notranslate"><span class="pre">nil</span></code>, a <code class="docutils literal notranslate"><span class="pre">suricatta.status</span></code> value, and a table with messages in
case of errors, else an empty table.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.getversion()</span></code> returns a table with SWUpdate’s <code class="docutils literal notranslate"><span class="pre">version</span></code>
and <code class="docutils literal notranslate"><span class="pre">patchlevel</span></code> fields. This information can be used to determine API
(in-)compatibility of the Lua suricatta module with the SWUpdate version running it.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.sleep(seconds)</span></code> is a wrapper around <cite>SLEEP(3)</cite> for, e.g.,
implementing a REST API call retry mechanism after a number of given seconds have
elapsed.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.get_tmpdir()</span></code> returns the path to SWUpdate’s temporary
working directory where, e.g., the <code class="docutils literal notranslate"><span class="pre">suricatta.download()</span></code> function may place the
downloaded artifacts.</p>
</section>
<section id="suricatta-status">
<h3><cite>suricatta.status</cite><a class="headerlink" href="#suricatta-status" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.status</span></code> table exposes the <code class="docutils literal notranslate"><span class="pre">server_op_res_t</span></code> enum values defined in
<code class="docutils literal notranslate"><span class="pre">include/util.h</span></code> to the Lua realm.</p>
</section>
<section id="suricatta-notify">
<h3><cite>suricatta.notify</cite><a class="headerlink" href="#suricatta-notify" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.notify</span></code> table provides the usual logging functions to the Lua
suricatta module matching their uppercase-named pendants available in the C realm.</p>
<p>One notable exception is <code class="docutils literal notranslate"><span class="pre">suricatta.notify.progress(message)</span></code> which dispatches the
message to the progress interface (see <a class="reference internal" href="progress.html"><span class="doc">Getting information on running update</span></a>). Custom progress client
implementations listening and acting on custom progress messages can be realized
using this function.</p>
<p>All notify functions return <code class="docutils literal notranslate"><span class="pre">nil</span></code>.</p>
</section>
<section id="suricatta-pstate">
<h3><cite>suricatta.pstate</cite><a class="headerlink" href="#suricatta-pstate" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.pstate</span></code> table provides a binding to SWUpdate’s (persistent) state
handling functions defined in <code class="docutils literal notranslate"><span class="pre">include/state.h</span></code>, however, limited to the bootloader
environment variable <code class="docutils literal notranslate"><span class="pre">STATE_KEY</span></code> defined by <code class="docutils literal notranslate"><span class="pre">CONFIG_UPDATE_STATE_BOOTLOADER</span></code> and
defaulting to <code class="docutils literal notranslate"><span class="pre">ustate</span></code>. In addition, it captures the <code class="docutils literal notranslate"><span class="pre">update_state_t</span></code> enum values.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.pstate.save(state)</span></code> requires one of <code class="docutils literal notranslate"><span class="pre">suricatta.pstate</span></code>’s
“enum” values as parameter and returns <code class="docutils literal notranslate"><span class="pre">true</span></code>, or, in case of error, <code class="docutils literal notranslate"><span class="pre">nil</span></code>.
The function <code class="docutils literal notranslate"><span class="pre">suricatta.pstate.get()</span></code> returns one of <code class="docutils literal notranslate"><span class="pre">suricatta.pstate</span></code>’s
“enum” values or, in case of error, <code class="docutils literal notranslate"><span class="pre">STATE_ERROR</span></code>.</p>
</section>
<section id="suricatta-server">
<h3><cite>suricatta.server</cite><a class="headerlink" href="#suricatta-server" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.server</span></code> table provides the sole function
<code class="docutils literal notranslate"><span class="pre">suricatta.server.register(function_p,</span> <span class="pre">purpose)</span></code>. It registers a Lua function
“pointed” to by <code class="docutils literal notranslate"><span class="pre">function_p</span></code> for the purpose <code class="docutils literal notranslate"><span class="pre">purpose</span></code> which is defined by
<code class="docutils literal notranslate"><span class="pre">suricatta.server</span></code>’s “enum” values. Those enum values correspond to the functions
defined in the interface outlined in the Section on <a class="reference internal" href="#the-suricatta-interface">The Suricatta Interface</a>.</p>
<p>In addition to these functions, the two callback functions <code class="docutils literal notranslate"><span class="pre">CALLBACK_PROGRESS</span></code> and
<code class="docutils literal notranslate"><span class="pre">CALLBACK_CHECK_CANCEL</span></code> can be registered optionally: The former can be used to upload
progress information to the server while the latter serves as <code class="docutils literal notranslate"><span class="pre">dwlwrdata</span></code> function
(see <code class="docutils literal notranslate"><span class="pre">include/channel_curl.h</span></code>) to decide on whether an installation should be aborted
while the download phase.</p>
<p>For details on the (callback) functions and their signatures, see the interface
specification <code class="docutils literal notranslate"><span class="pre">suricatta/suricatta.lua</span></code> and the documented example Lua suricatta
module found in <code class="docutils literal notranslate"><span class="pre">examples/suricatta/swupdate_suricatta.lua</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.server.register()</span></code> function returns <code class="docutils literal notranslate"><span class="pre">true</span></code>, or, in case of error,
<code class="docutils literal notranslate"><span class="pre">nil</span></code>.</p>
</section>
<section id="suricatta-channel">
<span id="id1"></span><h3><cite>suricatta.channel</cite><a class="headerlink" href="#suricatta-channel" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.channel</span></code> table captures channel handling for suricatta Lua modules.
The single function <code class="docutils literal notranslate"><span class="pre">suricatta.channel.open(options)</span></code> creates and opens a channel
to a server. Its single parameter <code class="docutils literal notranslate"><span class="pre">options</span></code> is a table specifying the channel’s
default options such as <cite>proxy</cite>, <cite>retries</cite>, <cite>usessl</cite>, <cite>strictssl</cite>, or
<cite>headers_to_send</cite>. For convenience, options that may change per request such as
<cite>url</cite>, <cite>content-type</cite>, or <cite>headers_to_send</cite> may be set as defaults on channel
creation time while being selectively overruled on a per request basis. The channel
options currently supported to be set are listed in the <code class="docutils literal notranslate"><span class="pre">suricatta.channel.options</span></code>
table. In essence, the <code class="docutils literal notranslate"><span class="pre">options</span></code> parameter table is the Lua table equivalent of
<code class="docutils literal notranslate"><span class="pre">include/channel_curl.h</span></code>’s <code class="docutils literal notranslate"><span class="pre">channel_data_t</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.channel.open(options)</span></code> function returns a channel table which is
either passed to the <code class="docutils literal notranslate"><span class="pre">suricatta.install()</span></code> and <code class="docutils literal notranslate"><span class="pre">suricatta.download()</span></code> functions
or used directly for communication with a server. More specifically, it has the three
functions</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get(options)</span></code> for retrieving information from the server,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">put(options)</span></code> for sending information to the server, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">close()</span></code> for closing the channel.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">put()</span></code> functions’ single parameter <code class="docutils literal notranslate"><span class="pre">options</span></code> is a per-request
channel option table as described above.</p>
<p>The functions <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">put()</span></code> return <code class="docutils literal notranslate"><span class="pre">true</span></code>, or, in case of error, <code class="docutils literal notranslate"><span class="pre">nil</span></code>,
a <code class="docutils literal notranslate"><span class="pre">suricatta.status</span></code> value, and an operation result table.
The latter contains the fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">http_response_code</span></code> carrying the HTTP error code,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">format</span></code> as one of <code class="docutils literal notranslate"><span class="pre">suricatta.channel.content</span></code>’s options,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw_reply</span></code> if <code class="docutils literal notranslate"><span class="pre">options</span></code> contained <code class="docutils literal notranslate"><span class="pre">format</span> <span class="pre">=</span> <span class="pre">suricatta.channel.content.RAW</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">json_reply</span></code> if <code class="docutils literal notranslate"><span class="pre">options</span></code> contained <code class="docutils literal notranslate"><span class="pre">format</span> <span class="pre">=</span> <span class="pre">suricatta.channel.content.JSON</span></code>, and</p></li>
<li><p>the HTTP headers received in the <code class="docutils literal notranslate"><span class="pre">received_headers</span></code> table, if any.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.channel.content</span></code> “enum” table defines the “format”, i.e., the response
body content type and whether to parse it or not:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NONE</span></code> means the response body is discarded.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAW</span></code> means the raw server’s reply is available as <code class="docutils literal notranslate"><span class="pre">raw_reply</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">JSON</span></code> means the server’s JSON reply is parsed into a Lua table and available
as <code class="docutils literal notranslate"><span class="pre">json_reply</span></code>.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.channel.method</span></code> “enum” table defines the HTTP method to use for
a request issued with the <code class="docutils literal notranslate"><span class="pre">put(options)</span></code> function, i.e., <cite>POST</cite>, <cite>PATCH</cite>, or <cite>PUT</cite> as
specified in the <code class="docutils literal notranslate"><span class="pre">options</span></code> parameter table via the <code class="docutils literal notranslate"><span class="pre">method</span></code> attribute.
In addition to the HTTP method, the request body’s content is set with the
<code class="docutils literal notranslate"><span class="pre">request_body</span></code> attribute in the <code class="docutils literal notranslate"><span class="pre">options</span></code> parameter table.</p>
<p>As a contrived example, consider the following call to a channel’s <code class="docutils literal notranslate"><span class="pre">put()</span></code> function</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="kd">local</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="n">put</span><span class="p">({</span>
        <span class="n">url</span>          <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">device_id</span><span class="p">),</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="n">method</span>       <span class="o">=</span> <span class="n">suricatta</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">PATCH</span><span class="p">,</span>
        <span class="n">format</span>       <span class="o">=</span> <span class="n">suricatta</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">NONE</span><span class="p">,</span>
        <span class="n">request_body</span> <span class="o">=</span> <span class="s2">&quot;{ ... }&quot;</span>
    <span class="p">})</span>
<span class="p">...</span>
</pre></div>
</div>
<p>that issues a HTTP <cite>PATCH</cite> to some URL with a JSON content without having interest in
the response body.</p>
<p>More examples of how to use a channel can be found in the example suricatta Lua
module <code class="docutils literal notranslate"><span class="pre">examples/suricatta/swupdate_suricatta.lua</span></code>.</p>
</section>
<section id="suricatta-bootloader">
<h3><cite>suricatta.bootloader</cite><a class="headerlink" href="#suricatta-bootloader" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader</span></code> table exposes SWUpdate’s bootloader environment
modification functions to suricatta Lua modules.</p>
<p>The enum-like table <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.bootloaders</span></code> holds the bootloaders
SWUpdate supports, i.e.</p>
<blockquote>
<div><div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">bootloaders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">EBG</span>   <span class="o">=</span> <span class="s2">&quot;ebg&quot;</span><span class="p">,</span>
    <span class="n">NONE</span>  <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="n">GRUB</span>  <span class="o">=</span> <span class="s2">&quot;grub&quot;</span><span class="p">,</span>
    <span class="n">UBOOT</span> <span class="o">=</span> <span class="s2">&quot;uboot&quot;</span><span class="p">,</span>
<span class="p">},</span>
</pre></div>
</div>
</div></blockquote>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.get()</span></code> returns the currently selected
bootloader in terms of a <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.bootloaders</span></code> field value.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.is(name)</span></code> takes one of
<code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.bootloaders</span></code>’s field values as <code class="docutils literal notranslate"><span class="pre">name</span></code> and returns
<code class="docutils literal notranslate"><span class="pre">true</span></code> if it is the currently selected bootloader, <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<p>The functions in the <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.env</span></code> table interact with the
currently selected bootloader’s environment:</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.env.get(variable)</span></code> retrieves the value
associated to <code class="docutils literal notranslate"><span class="pre">variable</span></code> from the bootloader’s environment.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.env.set(variable,</span> <span class="pre">value)</span></code> sets the
bootloader environment’s key <code class="docutils literal notranslate"><span class="pre">variable</span></code> to <code class="docutils literal notranslate"><span class="pre">value</span></code>.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.env.unset(variable)</span></code> deletes the bootloader
environment’s key <code class="docutils literal notranslate"><span class="pre">variable</span></code>.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">suricatta.bootloader.env.apply(filename)</span></code> applies
all key=value lines of a local file <code class="docutils literal notranslate"><span class="pre">filename</span></code> to the currently selected
bootloader’s environment.</p>
</section>
<section id="lua-suricatta-interface-specification">
<span id="suricatta-lua-specification"></span><h3>Lua Suricatta Interface Specification<a class="headerlink" href="#lua-suricatta-interface-specification" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">--[[</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="cm">    SWUpdate Suricatta Lua Module.</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="cm">    Interface specification for the Lua module provided by the</span>
<span class="linenos">  6</span><span class="cm">    &quot;Suricatta Lua module&quot; suricatta &quot;server&quot; (suricatta/server_lua.c).</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="cm">    Author: Christian Storm &lt;christian.storm@siemens.com&gt;</span>
<span class="linenos">  9</span><span class="cm">    Copyright (C) 2022, Siemens AG</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="cm">    SPDX-License-Identifier: GPL-2.0-or-later</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span><span class="cm">--]]</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="c1">---@diagnostic disable: missing-return</span>
<span class="linenos"> 16</span><span class="c1">---@diagnostic disable: unused-local</span>
<span class="linenos"> 17</span><span class="c1">-- luacheck: no max line length</span>
<span class="linenos"> 18</span><span class="c1">-- luacheck: no unused args</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="c1">-- Note: Definitions prefixed with `---` are not part of the SWUpdate functionality</span>
<span class="linenos"> 21</span><span class="c1">-- exposed to the Lua realm but instead are `typedef`-alikes returned by a function</span>
<span class="linenos"> 22</span><span class="c1">-- of the SWUpdate Suricatta Lua Module. Nonetheless, they are in the suricatta</span>
<span class="linenos"> 23</span><span class="c1">-- &quot;namespace&quot; for avoiding name clashes and, not least, convenience.</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="c1">--- SWUpdate Suricatta Binding.</span>
<span class="linenos"> 26</span><span class="c1">--</span>
<span class="linenos"> 27</span><span class="c1">--- @class suricatta</span>
<span class="linenos"> 28</span><span class="kd">local</span> <span class="n">suricatta</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="c1">--- @enum suricatta.status</span>
<span class="linenos"> 31</span><span class="c1">--- Lua equivalent of `server_op_res_t` enum as in `include/util.h`.</span>
<span class="linenos"> 32</span><span class="n">suricatta</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 33</span>    <span class="n">OK</span>                  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 34</span>    <span class="n">EERR</span>                <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 35</span>    <span class="n">EBADMSG</span>             <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos"> 36</span>    <span class="n">EINIT</span>               <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos"> 37</span>    <span class="n">EACCES</span>              <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos"> 38</span>    <span class="n">EAGAIN</span>              <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos"> 39</span>    <span class="n">UPDATE_AVAILABLE</span>    <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="linenos"> 40</span>    <span class="n">NO_UPDATE_AVAILABLE</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="linenos"> 41</span>    <span class="n">UPDATE_CANCELED</span>     <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="linenos"> 42</span>    <span class="n">ID_REQUESTED</span>        <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
<span class="linenos"> 43</span><span class="p">}</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="c1">--- SWUpdate notify function bindings.</span>
<span class="linenos"> 47</span><span class="c1">--</span>
<span class="linenos"> 48</span><span class="c1">-- Translates to `notify(string.format(message, ...))`,</span>
<span class="linenos"> 49</span><span class="c1">-- @see `corelib/lua_interface.c`</span>
<span class="linenos"> 50</span><span class="c1">--</span>
<span class="linenos"> 51</span><span class="c1">--- @class suricatta.notify</span>
<span class="linenos"> 52</span><span class="n">suricatta</span><span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 53</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 54</span>    <span class="nb">error</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 55</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 56</span>    <span class="n">trace</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 57</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 58</span>    <span class="n">debug</span>    <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 59</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 60</span>    <span class="n">info</span>     <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 61</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 62</span>    <span class="nb">warn</span>     <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 63</span>    <span class="c1">--- @type fun(message: string, ...: any)</span>
<span class="linenos"> 64</span>    <span class="n">progress</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos"> 65</span><span class="p">}</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="c1">--- SWUpdate&#39;s bootloader interface as in `include/bootloader.h`.</span>
<span class="linenos"> 69</span><span class="c1">--</span>
<span class="linenos"> 70</span><span class="c1">--- @class suricatta.bootloader</span>
<span class="linenos"> 71</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 72</span>    <span class="c1">--- @enum suricatta.bootloader.bootloaders</span>
<span class="linenos"> 73</span>    <span class="c1">--- Bootloaders supported by SWUpdate.</span>
<span class="linenos"> 74</span>    <span class="n">bootloaders</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 75</span>        <span class="n">EBG</span>   <span class="o">=</span> <span class="s2">&quot;ebg&quot;</span><span class="p">,</span>
<span class="linenos"> 76</span>        <span class="n">NONE</span>  <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="linenos"> 77</span>        <span class="n">GRUB</span>  <span class="o">=</span> <span class="s2">&quot;grub&quot;</span><span class="p">,</span>
<span class="linenos"> 78</span>        <span class="n">UBOOT</span> <span class="o">=</span> <span class="s2">&quot;uboot&quot;</span><span class="p">,</span>
<span class="linenos"> 79</span>    <span class="p">},</span>
<span class="linenos"> 80</span><span class="p">}</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="c1">--- Get currently set bootloader&#39;s name.</span>
<span class="linenos"> 83</span><span class="c1">--</span>
<span class="linenos"> 84</span><span class="c1">--- @return suricatta.bootloader.bootloaders | nil  # Name of currently set bootloader</span>
<span class="linenos"> 85</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="c1">--- Test whether bootloader `name` is currently set.</span>
<span class="linenos"> 88</span><span class="c1">--</span>
<span class="linenos"> 89</span><span class="c1">--- @param  name     suricatta.bootloader.bootloaders  Name of bootloader to test for being currently selected</span>
<span class="linenos"> 90</span><span class="c1">--- @return boolean                                    # True if `name` is currently set bootloader, false otherwise</span>
<span class="linenos"> 91</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">is</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="c1">--- Operations on the currently set bootloader&#39;s environment.</span>
<span class="linenos"> 94</span><span class="c1">--</span>
<span class="linenos"> 95</span><span class="c1">--- @class suricatta.bootloader.env</span>
<span class="linenos"> 96</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="c1">--- Get value of a bootloader environment variable.</span>
<span class="linenos"> 99</span><span class="c1">--</span>
<span class="linenos">100</span><span class="c1">--- @param  variable  string  Name of the bootloader environment variable to get value for</span>
<span class="linenos">101</span><span class="c1">--- @return string | nil      # Value of the bootloader environment variable or nil if non-existent</span>
<span class="linenos">102</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="c1">--- Set value of a bootloader environment variable.</span>
<span class="linenos">105</span><span class="c1">--</span>
<span class="linenos">106</span><span class="c1">--- @param  variable  string  Name of the bootloader environment variable to set</span>
<span class="linenos">107</span><span class="c1">--- @param  value     string  Value to set the bootloader environment variable `variable` to</span>
<span class="linenos">108</span><span class="c1">--- @return boolean | nil     # True on success, nil on error</span>
<span class="linenos">109</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="c1">--- Drop a bootloader environment variable.</span>
<span class="linenos">112</span><span class="c1">--</span>
<span class="linenos">113</span><span class="c1">--- @param  variable  string  Name of the bootloader environment variable to drop</span>
<span class="linenos">114</span><span class="c1">--- @return boolean | nil     # True on success, nil on error</span>
<span class="linenos">115</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">unset</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="c1">--- Set multiple bootloader environment variables from local file.</span>
<span class="linenos">118</span><span class="c1">--</span>
<span class="linenos">119</span><span class="c1">--- @param  filename  string  Path to local file in format `&lt;variable&gt;=&lt;value&gt;`</span>
<span class="linenos">120</span><span class="c1">--- @return boolean | nil     # True on success, nil on error</span>
<span class="linenos">121</span><span class="n">suricatta</span><span class="p">.</span><span class="n">bootloader</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">apply</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">122</span>
<span class="linenos">123</span>
<span class="linenos">124</span><span class="c1">--- SWUpdate&#39;s persistent state IDs as in `include/state.h` and reverse-lookup.</span>
<span class="linenos">125</span><span class="c1">--</span>
<span class="linenos">126</span><span class="c1">--- @class suricatta.pstate</span>
<span class="linenos">127</span><span class="n">suricatta</span><span class="p">.</span><span class="n">pstate</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">128</span>    <span class="n">OK</span>            <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
<span class="linenos">129</span>    <span class="n">INSTALLED</span>     <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;INSTALLED&quot;</span><span class="p">,</span>
<span class="linenos">130</span>    <span class="n">TESTING</span>       <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;TESTING&quot;</span><span class="p">,</span>
<span class="linenos">131</span>    <span class="n">FAILED</span>        <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span>
<span class="linenos">132</span>    <span class="n">NOT_AVAILABLE</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;NOT_AVAILABLE&quot;</span><span class="p">,</span>
<span class="linenos">133</span>    <span class="n">ERROR</span>         <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
<span class="linenos">134</span>    <span class="n">WAIT</span>          <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;WAIT&quot;</span><span class="p">,</span>
<span class="linenos">135</span>    <span class="n">IN_PROGRESS</span>   <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">string.byte</span><span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;IN_PROGRESS&quot;</span><span class="p">,</span>
<span class="linenos">136</span><span class="p">}</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="c1">--- Get the current stored persistent state.</span>
<span class="linenos">139</span><span class="c1">--</span>
<span class="linenos">140</span><span class="c1">--- @return number   # Persistent state ID number, suricatta.pstate.ERROR if unsuccessful</span>
<span class="linenos">141</span><span class="n">suricatta</span><span class="p">.</span><span class="n">pstate</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">142</span>
<span class="linenos">143</span><span class="c1">--- Save persistent state information.</span>
<span class="linenos">144</span><span class="c1">--</span>
<span class="linenos">145</span><span class="c1">--- @param  state  number  Persistent state ID number</span>
<span class="linenos">146</span><span class="c1">--- @return boolean | nil  # True on success, nil on error</span>
<span class="linenos">147</span><span class="n">suricatta</span><span class="p">.</span><span class="n">pstate</span><span class="p">.</span><span class="n">save</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">148</span>
<span class="linenos">149</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="c1">--- Function registry IDs for Lua suricatta functions.</span>
<span class="linenos">152</span><span class="c1">--</span>
<span class="linenos">153</span><span class="c1">--- @class suricatta.server</span>
<span class="linenos">154</span><span class="n">suricatta</span><span class="p">.</span><span class="n">server</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">155</span>    <span class="n">HAS_PENDING_ACTION</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">156</span>    <span class="n">INSTALL_UPDATE</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">157</span>    <span class="n">SEND_TARGET_DATA</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">158</span>    <span class="n">GET_POLLING_INTERVAL</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos">159</span>    <span class="n">SERVER_START</span>          <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos">160</span>    <span class="n">SERVER_STOP</span>           <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos">161</span>    <span class="n">IPC</span>                   <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="linenos">162</span>    <span class="n">PRINT_HELP</span>            <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="linenos">163</span>    <span class="n">CALLBACK_PROGRESS</span>     <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="linenos">164</span>    <span class="n">CALLBACK_CHECK_CANCEL</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
<span class="linenos">165</span><span class="p">}</span>
<span class="linenos">166</span>
<span class="linenos">167</span><span class="c1">--- Register a Lua function as Suricatta interface implementation.</span>
<span class="linenos">168</span><span class="c1">--</span>
<span class="linenos">169</span><span class="c1">--- @param  function_p  function   Function to register for `purpose`</span>
<span class="linenos">170</span><span class="c1">--- @param  purpose     number     Suricatta interface function implemented (one of suricatta.server&#39;s enums)</span>
<span class="linenos">171</span><span class="c1">--- @return boolean                # Whether operation was successful or not</span>
<span class="linenos">172</span><span class="n">suricatta</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">register</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">function_p</span><span class="p">,</span> <span class="n">purpose</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">173</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="c1">--- Channel result table.</span>
<span class="linenos">176</span><span class="c1">--</span>
<span class="linenos">177</span><span class="c1">-- Result in return of a channel operation.</span>
<span class="linenos">178</span><span class="c1">--</span>
<span class="linenos">179</span><span class="c1">--- @class suricatta.channel_operation_result</span>
<span class="linenos">180</span><span class="c1">--- @field http_response_code  number</span>
<span class="linenos">181</span><span class="c1">--- @field format              suricatta.channel.content</span>
<span class="linenos">182</span><span class="c1">--- @field json_reply          table | nil   Table if `format` was `suricatta.channel.content.JSON`</span>
<span class="linenos">183</span><span class="c1">--- @field raw_reply           string | nil  Table if `format` was `suricatta.channel.content.RAW`</span>
<span class="linenos">184</span><span class="c1">--- @field received_headers    table&lt;string, string&gt; | nil</span>
<span class="linenos">185</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="c1">--- Options and methods on the opened channel.</span>
<span class="linenos">188</span><span class="c1">--</span>
<span class="linenos">189</span><span class="c1">-- Table as returned by `suricatta.channel.open()`.</span>
<span class="linenos">190</span><span class="c1">--</span>
<span class="linenos">191</span><span class="c1">--- @class suricatta.open_channel</span>
<span class="linenos">192</span><span class="c1">--- @field options  suricatta.channel.options                                                                               Channel creation-time set options as in `include/channel_curl.h`.</span>
<span class="linenos">193</span><span class="c1">--- @field get      fun(options: suricatta.channel.options): boolean, suricatta.status, suricatta.channel_operation_result  Channel get operation</span>
<span class="linenos">194</span><span class="c1">--- @field put      fun(options: suricatta.channel.options): boolean, suricatta.status, suricatta.channel_operation_result  Channel put operation</span>
<span class="linenos">195</span><span class="c1">--- @field close    fun()                                                                                                   Channel close operation</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="c1">--- @class suricatta.channel</span>
<span class="linenos">198</span><span class="n">suricatta</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">199</span>
<span class="linenos">200</span>    <span class="c1">-- Lua-alike of proxy environment variable usage marker as in `include/channel_curl.h`.</span>
<span class="linenos">201</span>    <span class="c1">-- An empty `proxy` string means to use proxy environment variables.</span>
<span class="linenos">202</span>    <span class="c1">-- @type string</span>
<span class="linenos">203</span>    <span class="n">USE_PROXY_ENV</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">204</span>
<span class="linenos">205</span>    <span class="c1">--- @enum suricatta.channel.content</span>
<span class="linenos">206</span>    <span class="c1">--- Content type passed over the channel as in `include/channel_curl.h`.</span>
<span class="linenos">207</span>    <span class="n">content</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">208</span>        <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">209</span>        <span class="n">JSON</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">210</span>        <span class="n">RAW</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">211</span>    <span class="p">},</span>
<span class="linenos">212</span>
<span class="linenos">213</span>    <span class="c1">--- @enum suricatta.channel.method</span>
<span class="linenos">214</span>    <span class="c1">--- Transfer method to use over channel as in `include/channel_curl.h`.</span>
<span class="linenos">215</span>    <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">216</span>        <span class="n">GET</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">217</span>        <span class="n">POST</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">218</span>        <span class="n">PUT</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">219</span>        <span class="n">PATCH</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos">220</span>    <span class="p">},</span>
<span class="linenos">221</span>
<span class="linenos">222</span>    <span class="c1">--- Channel options as in `include/channel_curl.h`.</span>
<span class="linenos">223</span>    <span class="c1">--</span>
<span class="linenos">224</span>    <span class="c1">--- @class suricatta.channel.options</span>
<span class="linenos">225</span>    <span class="c1">--- @field url                 string | nil   `CURLOPT_URL` - URL for this transfer</span>
<span class="linenos">226</span>    <span class="c1">--- @field cached_file         string | nil   Resume download from cached file at path</span>
<span class="linenos">227</span>    <span class="c1">--- @field auth                string | nil   `CURLOPT_USERPWD` - user name and password to use in authentication</span>
<span class="linenos">228</span>    <span class="c1">--- @field request_body        string | nil   Data to send to server for `PUT` and `POST`</span>
<span class="linenos">229</span>    <span class="c1">--- @field iface               string | nil   `CURLOPT_INTERFACE` - source interface for outgoing traffic</span>
<span class="linenos">230</span>    <span class="c1">--- @field dry_run             boolean | nil  `swupdate_request`&#39;s dry_run field as in `include/network_ipc.h`</span>
<span class="linenos">231</span>    <span class="c1">--- @field cafile              string | nil   `CURLOPT_CAINFO` - path to Certificate Authority (CA) bundle</span>
<span class="linenos">232</span>    <span class="c1">--- @field sslkey              string | nil   `CURLOPT_SSLKEY` - private key file for TLS and SSL client cert</span>
<span class="linenos">233</span>    <span class="c1">--- @field sslcert             string | nil   `CURLOPT_SSLCERT` - SSL client certificate</span>
<span class="linenos">234</span>    <span class="c1">--- @field ciphers             string | nil   `CURLOPT_SSL_CIPHER_LIST` - ciphers to use for TLS</span>
<span class="linenos">235</span>    <span class="c1">--- @field proxy               string | nil   `CURLOPT_PROXY` - proxy to use</span>
<span class="linenos">236</span>    <span class="c1">--- @field info                string | nil   `swupdate_request`&#39;s info field as in `include/network_ipc.h`</span>
<span class="linenos">237</span>    <span class="c1">--- @field auth_token          string | nil   String appended to Header</span>
<span class="linenos">238</span>    <span class="c1">--- @field content_type        string | nil   `Content-Type:` and `Accept:` appended to Header</span>
<span class="linenos">239</span>    <span class="c1">--- @field retry_sleep         number | nil   Time to wait prior to retry and resume a download</span>
<span class="linenos">240</span>    <span class="c1">--- @field method              suricatta.channel.method | nil  Channel transfer method to use</span>
<span class="linenos">241</span>    <span class="c1">--- @field retries             number | nil   Maximal download attempt count</span>
<span class="linenos">242</span>    <span class="c1">--- @field low_speed_timeout   number | nil   `CURLOPT_LOW_SPEED_TIME` - low speed limit time period</span>
<span class="linenos">243</span>    <span class="c1">--- @field connection_timeout  number | nil   `CURLOPT_CONNECTTIMEOUT` - timeout for the connect phase</span>
<span class="linenos">244</span>    <span class="c1">--- @field format              suricatta.channel.content | nil  Content type passed over the channel</span>
<span class="linenos">245</span>    <span class="c1">--- @field debug               boolean | nil  Set channel debug logging</span>
<span class="linenos">246</span>    <span class="c1">--- @field usessl              boolean | nil  Enable SSL hash sum calculation</span>
<span class="linenos">247</span>    <span class="c1">--- @field strictssl           boolean | nil  `CURLOPT_SSL_VERIFYHOST` + `CURLOPT_SSL_VERIFYPEER`</span>
<span class="linenos">248</span>    <span class="c1">--- @field nocheckanswer       boolean | nil  Whether the reply is interpreted/logged and tried to be parsed</span>
<span class="linenos">249</span>    <span class="c1">--- @field nofollow            boolean | nil  `CURLOPT_FOLLOWLOCATION` - follow HTTP 3xx redirects</span>
<span class="linenos">250</span>    <span class="c1">--- @field max_download_speed  string | nil   `CURLOPT_MAX_RECV_SPEED_LARGE` - rate limit data download speed</span>
<span class="linenos">251</span>    <span class="c1">--- @field headers_to_send     table&lt;string, string&gt; | nil  Header to send</span>
<span class="linenos">252</span>    <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="c1">--- Open a new channel.</span>
<span class="linenos">255</span>    <span class="c1">--</span>
<span class="linenos">256</span>    <span class="c1">--- @param  options  suricatta.channel.options  Channel default options overridable per operation</span>
<span class="linenos">257</span>    <span class="c1">--- @return boolean                             # Whether operation was successful or not</span>
<span class="linenos">258</span>    <span class="c1">--- @return suricatta.open_channel              # Options of and operations on the opened channel</span>
<span class="linenos">259</span>    <span class="n">open</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos">260</span><span class="p">}</span>
<span class="linenos">261</span>
<span class="linenos">262</span>
<span class="linenos">263</span><span class="c1">--- Channel and Options Table to use for an operation.</span>
<span class="linenos">264</span><span class="c1">--</span>
<span class="linenos">265</span><span class="c1">-- Channel to use for the download / installation operation as returned by `suricatta.channel.open()`</span>
<span class="linenos">266</span><span class="c1">-- plus channel options overriding the defaults per operation (@see suricatta.channel.options)</span>
<span class="linenos">267</span><span class="c1">-- and specific options to the download / installation operation, e.g., `drain_messages`.</span>
<span class="linenos">268</span><span class="c1">--</span>
<span class="linenos">269</span><span class="c1">--- @class suricatta.operation_channel</span>
<span class="linenos">270</span><span class="c1">--- @field channel          suricatta.open_channel           Channel table as returned by `suricatta.channel.open()`</span>
<span class="linenos">271</span><span class="c1">--- @field drain_messages   boolean  | nil                   Whether to flush all progress messages or only those while in-flight operation (default)</span>
<span class="linenos">272</span><span class="c1">--- @field ∈                suricatta.channel.options | nil  Channel options to override for this operation</span>
<span class="linenos">273</span>
<span class="linenos">274</span><span class="c1">--- Install an update artifact from remote server or local file.</span>
<span class="linenos">275</span><span class="c1">--</span>
<span class="linenos">276</span><span class="c1">-- If the protocol specified in Table `install_channel`&#39;s `url` field is `file://`,</span>
<span class="linenos">277</span><span class="c1">-- a local update artifact file is installed. If it is, e.g., `https://`, the</span>
<span class="linenos">278</span><span class="c1">-- update artifact is downloaded *and* installed.</span>
<span class="linenos">279</span><span class="c1">-- Note that this file is to be deleted, if applicable, from the Lua realm.</span>
<span class="linenos">280</span><span class="c1">--</span>
<span class="linenos">281</span><span class="c1">--- @see suricatta.download</span>
<span class="linenos">282</span><span class="c1">--- @param  install_channel  suricatta.operation_channel  Channel to use for the download+installation operation</span>
<span class="linenos">283</span><span class="c1">--- @return boolean                                       # Whether operation was successful or not</span>
<span class="linenos">284</span><span class="c1">--- @return suricatta.status                              # Suricatta return code</span>
<span class="linenos">285</span><span class="c1">--- @return table&lt;number, string&gt;                         # Error messages, if any</span>
<span class="linenos">286</span><span class="n">suricatta</span><span class="p">.</span><span class="n">install</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">install_channel</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">287</span>
<span class="linenos">288</span><span class="c1">--- Download an update artifact from remote server.</span>
<span class="linenos">289</span><span class="c1">--</span>
<span class="linenos">290</span><span class="c1">-- `suricatta.download()` just downloads an update artifact from the remote server</span>
<span class="linenos">291</span><span class="c1">-- without installing it. For later installation, call `suricatta.install()` with</span>
<span class="linenos">292</span><span class="c1">-- an appropriate `install_channel` Table&#39;s `url` field.</span>
<span class="linenos">293</span><span class="c1">--</span>
<span class="linenos">294</span><span class="c1">--- @see suricatta.install</span>
<span class="linenos">295</span><span class="c1">--- @param  download_channel  suricatta.operation_channel  Channel to use for the download operation</span>
<span class="linenos">296</span><span class="c1">--- @param  localpath         string                       Path where to store the downloaded artifact to</span>
<span class="linenos">297</span><span class="c1">--- @return boolean                                        # Whether operation was successful or not</span>
<span class="linenos">298</span><span class="c1">--- @return suricatta.status                               # Suricatta return code</span>
<span class="linenos">299</span><span class="c1">--- @return table&lt;number, string&gt;                          # Error messages, if any</span>
<span class="linenos">300</span><span class="n">suricatta</span><span class="p">.</span><span class="n">download</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">download_channel</span><span class="p">,</span> <span class="n">localpath</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">301</span>
<span class="linenos">302</span>
<span class="linenos">303</span><span class="c1">--- Sleep for a number of seconds.</span>
<span class="linenos">304</span><span class="c1">--</span>
<span class="linenos">305</span><span class="c1">-- Call `SLEEP(3)` via C realm.</span>
<span class="linenos">306</span><span class="c1">--</span>
<span class="linenos">307</span><span class="c1">--- @param seconds number  # Number of seconds to sleep</span>
<span class="linenos">308</span><span class="n">suricatta</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">309</span>
<span class="linenos">310</span>
<span class="linenos">311</span><span class="c1">--- Get TMPDIR from SWUpdate.</span>
<span class="linenos">312</span><span class="c1">--</span>
<span class="linenos">313</span><span class="c1">-- @see `core/util.c` :: get_tmpdir()</span>
<span class="linenos">314</span><span class="c1">--</span>
<span class="linenos">315</span><span class="c1">--- @return string  # TMPDIR path</span>
<span class="linenos">316</span><span class="n">suricatta</span><span class="p">.</span><span class="n">get_tmpdir</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">317</span>
<span class="linenos">318</span>
<span class="linenos">319</span><span class="c1">--- SWUpdate version information.</span>
<span class="linenos">320</span><span class="c1">--- @class suricatta.version</span>
<span class="linenos">321</span><span class="c1">--- @field [1]         number  SWUpdate&#39;s version</span>
<span class="linenos">322</span><span class="c1">--- @field [2]         number  SWUpdate&#39;s patch level</span>
<span class="linenos">323</span><span class="c1">--- @field version     number  SWUpdate&#39;s version</span>
<span class="linenos">324</span><span class="c1">--- @field patchlevel  number  SWUpdate&#39;s patch level</span>
<span class="linenos">325</span>
<span class="linenos">326</span><span class="c1">--- Get SWUpdate version.</span>
<span class="linenos">327</span><span class="c1">--</span>
<span class="linenos">328</span><span class="c1">--- @return suricatta.version  # Table with `version` and `patchlevel` fields</span>
<span class="linenos">329</span><span class="n">suricatta</span><span class="p">.</span><span class="n">getversion</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">330</span>
<span class="linenos">331</span>
<span class="linenos">332</span><span class="c1">--- SWUpdate IPC types and definitions.</span>
<span class="linenos">333</span><span class="c1">--</span>
<span class="linenos">334</span><span class="c1">--- @class suricatta.ipc</span>
<span class="linenos">335</span><span class="n">suricatta</span><span class="p">.</span><span class="n">ipc</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">336</span>
<span class="linenos">337</span><span class="c1">--- @enum suricatta.ipc.sourcetype</span>
<span class="linenos">338</span><span class="c1">--- Lua equivalent of `sourcetype` as in `include/swupdate_status.h`.</span>
<span class="linenos">339</span><span class="n">suricatta</span><span class="p">.</span><span class="n">ipc</span><span class="p">.</span><span class="n">sourcetype</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">340</span>    <span class="n">SOURCE_UNKNOWN</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">341</span>    <span class="n">SOURCE_WEBSERVER</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">342</span>    <span class="n">SOURCE_SURICATTA</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">343</span>    <span class="n">SOURCE_DOWNLOADER</span>        <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos">344</span>    <span class="n">SOURCE_LOCAL</span>             <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos">345</span>    <span class="n">SOURCE_CHUNKS_DOWNLOADER</span> <span class="o">=</span> <span class="mi">5</span>
<span class="linenos">346</span><span class="p">}</span>
<span class="linenos">347</span>
<span class="linenos">348</span><span class="c1">--- @enum suricatta.ipc.RECOVERY_STATUS</span>
<span class="linenos">349</span><span class="c1">--- Lua equivalent of `RECOVERY_STATUS` as in `include/swupdate_status.h`.</span>
<span class="linenos">350</span><span class="n">suricatta</span><span class="p">.</span><span class="n">ipc</span><span class="p">.</span><span class="n">RECOVERY_STATUS</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">351</span>    <span class="n">IDLE</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">352</span>    <span class="n">START</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">353</span>    <span class="n">RUN</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">354</span>    <span class="n">SUCCESS</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos">355</span>    <span class="n">FAILURE</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos">356</span>    <span class="n">DOWNLOAD</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos">357</span>    <span class="n">DONE</span>       <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="linenos">358</span>    <span class="n">SUBPROCESS</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="linenos">359</span>    <span class="n">PROGRESS</span>   <span class="o">=</span> <span class="mi">8</span>
<span class="linenos">360</span><span class="p">}</span>
<span class="linenos">361</span>
<span class="linenos">362</span><span class="c1">--- @enum suricatta.ipc.progress_cause</span>
<span class="linenos">363</span><span class="c1">--- Lua equivalent of `progress_cause_t` as in `include/progress_ipc.h`.</span>
<span class="linenos">364</span><span class="n">suricatta</span><span class="p">.</span><span class="n">ipc</span><span class="p">.</span><span class="n">progress_cause</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">365</span>    <span class="n">CAUSE_NONE</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">366</span>    <span class="n">CAUSE_REBOOT_MODE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">367</span><span class="p">}</span>
<span class="linenos">368</span>
<span class="linenos">369</span><span class="c1">--- Lua-alike of `progress_msg` as in `include/progress_ipc.h`.</span>
<span class="linenos">370</span><span class="c1">--</span>
<span class="linenos">371</span><span class="c1">--- @class suricatta.ipc.progress_msg</span>
<span class="linenos">372</span><span class="c1">--- @field magic        number                         SWUpdate IPC magic number</span>
<span class="linenos">373</span><span class="c1">--- @field status       suricatta.ipc.RECOVERY_STATUS  Update status</span>
<span class="linenos">374</span><span class="c1">--- @field dwl_percent  number                         Percent of downloaded data</span>
<span class="linenos">375</span><span class="c1">--- @field nsteps       number                         Total steps count</span>
<span class="linenos">376</span><span class="c1">--- @field cur_step     number                         Current step</span>
<span class="linenos">377</span><span class="c1">--- @field cur_percent  number                         Percent in current step</span>
<span class="linenos">378</span><span class="c1">--- @field cur_image    string                         Name of the current image to be installed (max: 256 chars)</span>
<span class="linenos">379</span><span class="c1">--- @field hnd_name     string                         Name of the running handler (max: 64 chars)</span>
<span class="linenos">380</span><span class="c1">--- @field source       suricatta.ipc.sourcetype       The source that has triggered the update</span>
<span class="linenos">381</span><span class="c1">--- @field info         string                         Additional information about the installation (max: 2048 chars)</span>
<span class="linenos">382</span><span class="c1">--- @field jsoninfo     table                          If `info` is JSON, according Lua Table</span>
<span class="linenos">383</span>
<span class="linenos">384</span><span class="c1">--- Lua enum of IPC commands as in `include/network_ipc.h`.</span>
<span class="linenos">385</span><span class="c1">--</span>
<span class="linenos">386</span><span class="c1">-- `CMD_ENABLE` is not passed through and hence not in `ipc_commands`</span>
<span class="linenos">387</span><span class="c1">-- as it&#39;s handled directly in `suricatta/suricatta.c`.</span>
<span class="linenos">388</span><span class="c1">--</span>
<span class="linenos">389</span><span class="c1">--- @type  {[string]: number}</span>
<span class="linenos">390</span><span class="c1">--- @class suricatta.ipc.ipc_commands</span>
<span class="linenos">391</span><span class="c1">--- @field ACTIVATION  number  0</span>
<span class="linenos">392</span><span class="c1">--- @field CONFIG      number  1</span>
<span class="linenos">393</span><span class="c1">--- @field GET_STATUS  number  3</span>
<span class="linenos">394</span>
<span class="linenos">395</span><span class="c1">--- Lua-alike of `ipc_message` as in `include/network_ipc.h`.</span>
<span class="linenos">396</span><span class="c1">--</span>
<span class="linenos">397</span><span class="c1">-- Note: Some members are deliberately not passed through to the Lua</span>
<span class="linenos">398</span><span class="c1">-- realm such as `ipc_message.data.len` since that&#39;s transparently</span>
<span class="linenos">399</span><span class="c1">-- handled by the C-to-Lua bridge.</span>
<span class="linenos">400</span><span class="c1">-- Note: This is not a direct equivalent but rather a &quot;sensible&quot; selection</span>
<span class="linenos">401</span><span class="c1">-- as, e.g., the `json` field is not present in `struct ipc_message`.</span>
<span class="linenos">402</span><span class="c1">--</span>
<span class="linenos">403</span><span class="c1">--- @class suricatta.ipc.ipc_message</span>
<span class="linenos">404</span><span class="c1">--- @field magic     number                      SWUpdate IPC magic number</span>
<span class="linenos">405</span><span class="c1">--- @field commands  suricatta.ipc.ipc_commands  IPC commands</span>
<span class="linenos">406</span><span class="c1">--- @field cmd       number                      Command number, one of `ipc_commands`&#39;s values</span>
<span class="linenos">407</span><span class="c1">--- @field msg       string                      String data sent via IPC</span>
<span class="linenos">408</span><span class="c1">--- @field json      table                       If `msg` is JSON, JSON as Lua Table</span>
<span class="linenos">409</span>
<span class="linenos">410</span>
<span class="linenos">411</span><span class="kr">return</span> <span class="n">suricatta</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mongoose.html" class="btn btn-neutral float-left" title="Mongoose daemon mode" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="hawkbit-setup.html" class="btn btn-neutral float-right" title="Config for hawkBit under SSL/TLS using private CA / sub CA" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, Stefano Babic.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>